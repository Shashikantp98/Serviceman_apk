import{u as b,b as L,a as S,r as n,c as P,o as C,A as m,j as e,H as E,e as R,S as A,f as F}from"./index-DEIqmbY-.js";const M=()=>{const _=b(),g=L(),{role:N}=S(),[l,w]=n.useState(!0),[x,f]=n.useState([]),u=P("notify-loader"),j=n.useRef(!1),r=n.useRef(new Map),v=n.useRef(!1),y=async(s=!1)=>{var t;console.log("ðŸ” fetchNotifications called, preserveSeenState:",s),u.setLoading(!0);try{const o=(await m.post("/user/listNotificationForCustomer",{})).data||[];if(console.log("ðŸ“¦ Fetched notifications:",o.map(i=>({id:i._id,is_seen:i.is_seen,is_read:i.is_read}))),s){const i=o.map(a=>r.current.has(a._id)?{...a,is_seen:r.current.get(a._id)}:a);console.log("âœ… Preserved state applied"),f(i)}else o.forEach(i=>{r.current.has(i._id)||r.current.set(i._id,i.is_seen)}),console.log("ðŸ’¾ Initial state stored"),f(o)}catch(c){console.error("Error:",c)}finally{u.setLoading(!1),w(!1),(t=g.state)!=null&&t.scrollPosition&&setTimeout(()=>{window.scrollTo({top:g.state.scrollPosition,behavior:"instant"})},50)}};n.useEffect(()=>{if(v.current){console.log("âš ï¸ Skipping duplicate fetch (StrictMode double mount)");return}v.current=!0,j.current=!0,y();let s;return C.addListener("pushNotificationReceived",t=>{console.log('ðŸ“¬ Push notification received, NOT refetching to preserve "New" badges'),t&&alert((t.title||"Notification")+": "+(t.body||""))}).then(t=>{s=t}),()=>{s&&s.remove(),j.current&&(console.log("Component unmounting - marking all as seen"),m.post("/user/markNotificationsAsSeen").catch(()=>{}))}},[]);const k=async(s,t)=>{const c=window.scrollY,{notify_type:o,booking_id:i,support_id:a,_id:d}=s;if(d&&!s.is_read&&m.post("/user/markNotificationAsRead",{notification_id:d}).then(()=>{console.log(`Notification ${d} marked as read`),f(p=>p.map(h=>h._id===d?{...h,is_read:!0}:h))}).catch(p=>console.error("Error marking notification as read:",p)),o==="booking"&&i){_(`/CustomerProjectinfo/${i}`,{state:{fromNotifications:!0,scrollPosition:c,itemIndex:t}});return}if(o==="support"&&a){_("/supportlist");return}console.warn("Unknown notification type:",s)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"customer_header_none"}),N==="customer"?e.jsx(E,{}):e.jsx(R,{}),e.jsxs("div",{className:N==="customer"?"container main-content pt-2":"container main-content-service",children:[e.jsx("div",{className:"fixed_header text-center",children:e.jsx("h1",{className:"head4",children:"Notifications"})}),e.jsxs("div",{className:"row px-2 mb-5 pb-5 fixed_header_padding",children:[e.jsx(A,{show:u.loading,size:"medium",text:"Loading notifications...",overlay:!0}),l&&e.jsx("div",{className:"col-12 text-center pt-5 fixed_header_padding",children:e.jsx("div",{className:"loader"})}),!l&&x.length===0&&e.jsxs("div",{className:"col-12 text-center mt-5 fixed_header_padding",children:[e.jsx("h1",{className:"bigemj",children:"ðŸ‘¨ðŸ¼â€ðŸ¦¯"}),e.jsx("p",{children:"No notifications found"})]}),!l&&x.map((s,t)=>e.jsx("div",{className:"col-12 mt-2",children:e.jsxs("div",{className:"nofi_cards",onClick:()=>k(s,t),style:{cursor:s.notify_type==="booking"&&s.booking_id||s.notify_type==="support"&&s.support_id?"pointer":"default"},children:[e.jsxs("p",{className:"notification_main_title",children:[s.title||"Notification",!s.is_seen&&e.jsx("span",{className:"new_notifications",children:"New"})]}),e.jsx("p",{className:`notfication_messages ${s.is_read?"":"new_message"}`,children:s.message}),e.jsxs("p",{className:"notification_date_time",children:[e.jsx(F,{size:14}),new Date(s.created_on).toLocaleString()]})]})},t))]})]})]})};export{M as default};

import{a as E,r as s,b as L,u as R,R as _,j as e,C as F,A as y}from"./index-DEIqmbY-.js";import{O as P}from"./otp-input-D2LM50Iq.js";const K=()=>{var k,b;const{login:N}=E(),[a,p]=s.useState(""),[d,f]=s.useState(null),[v,C]=s.useState(0),h=L(),T=(k=h.state)==null?void 0:k.phone_number,n=(b=h.state)==null?void 0:b.user_type,[i,l]=s.useState(!1),[g,w]=s.useState(!1),c=R(),u=s.useRef(null);_.useEffect(()=>{const t=()=>{window.fcmToken&&window.fcmToken!==""?w(!0):setTimeout(t,500)};t()},[]);const x=async t=>{var r,j;if(!i&&u.current!==t){u.current=t,l(!0),f(null);try{const o=window.fcmToken||"";console.log("Logging in with FCM Token:",o);const m=await y.post("/user/loginUser",{phone_number:T,pin:t,user_type:n,fcm_token:o});l(!1),N(m.data.token,n),await y.post("/user/updateFcmToken",{fcm_token:o,user_type:n}),n==="customer"&&c("/home"),n==="servicemen"&&c("/dashboard")}catch(o){console.log(o),f(((j=(r=o.response)==null?void 0:r.data)==null?void 0:j.message)||"Login failed"),p(""),C(m=>m+1),l(!1),u.current=null}}};s.useEffect(()=>{if(a.length===6){const t=setTimeout(()=>{x(a)},200);return()=>clearTimeout(t)}},[a]);const S=t=>{const r=t.replace(/\D/g,"");p(r)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute"},children:e.jsxs("button",{className:"back-btn mb-3 mt-5 px-3 py-3",style:{color:"#000"},onClick:()=>c(-1),children:[e.jsx(F,{})," Back"]})}),e.jsxs("div",{className:"px-5 pt-5 pb-3",children:[e.jsx("h3",{className:"head2 pt-5",children:"Enter Pin"}),e.jsx("p",{className:"text-center color-grey font-12",children:"Enter your pin for login and security"})]}),e.jsx("div",{className:"otp",children:e.jsx(P,{length:6,onChange:S,className:"otp-input-container",inputClassName:"input"},v)}),d&&e.jsx("p",{className:"text-danger font-14 mt-1 text-center",children:d}),e.jsx("p",{className:"para2 mb-1 mt-4",style:{display:"flex",justifyContent:"center"},children:e.jsxs("b",{className:"text-black d-block pt-1",children:["Forgot PIN?"," ",e.jsx("span",{className:"text-decoration-underline",onClick:()=>c("/forgot-phone",{state:{role:n}}),children:"Click here"})]})}),e.jsx("div",{className:"px-4 mt-5",children:e.jsx("button",{className:"fill_half",onClick:()=>x(a),disabled:a.length!==6||i||!g,children:g?i?"Login...":"Login":"Getting device token..."})})]})};export{K as default};
